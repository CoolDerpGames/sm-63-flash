(()=>{"use strict";const e={ruffleEnable:!0,ignoreOptout:!1};let t,s,r,o,n,a,c,i,d,g,u;function l(e){return new Promise(((t,s)=>{e((e=>{const r=chrome.runtime.lastError;r?s(r):t(e)}))}))}if("undefined"!=typeof chrome)t={getMessage:e=>chrome.i18n.getMessage(e)},s={local:{get:e=>l((t=>chrome.storage.local.get(e,t))),remove:e=>l((t=>chrome.storage.local.remove(e,t))),set:e=>l((t=>chrome.storage.local.set(e,t)))},sync:{get:e=>l((t=>chrome.storage.sync.get(e,t))),remove:e=>l((t=>chrome.storage.sync.remove(e,t))),set:e=>l((t=>chrome.storage.sync.set(e,t)))},onChanged:{addListener:e=>chrome.storage.onChanged.addListener(e)}},r={reload:e=>l((t=>chrome.tabs.reload(e,void 0,t))),query:e=>l((t=>chrome.tabs.query(e,t))),sendMessage:(e,t,s)=>l((r=>chrome.tabs.sendMessage(e,t,s,r)))},o={onMessage:{addListener:e=>chrome.runtime.onMessage.addListener(e)},getURL:e=>chrome.runtime.getURL(e)},n=()=>l((e=>chrome.tabs.create({url:"/options.html"},e)));else{if("undefined"==typeof browser)throw new Error("Extension API not found.");t={getMessage:e=>browser.i18n.getMessage(e)},s={local:{get:e=>browser.storage.local.get(e),remove:e=>browser.storage.local.remove(e),set:e=>browser.storage.local.set(e)},sync:{get:e=>browser.storage.sync.get(e),remove:e=>browser.storage.sync.remove(e),set:e=>browser.storage.sync.set(e)},onChanged:{addListener:e=>browser.storage.onChanged.addListener(e)}},r={reload:e=>browser.tabs.reload(e),query:e=>browser.tabs.query(e),sendMessage:(e,t,s)=>browser.tabs.sendMessage(e,t,s)},o={onMessage:{addListener:e=>browser.runtime.onMessage.addListener(e)},getURL:e=>browser.runtime.getURL(e)},n=()=>browser.runtime.openOptionsPage()}const b={status_init:"gray",status_no_tabs:"red",status_tabs_error:"red",status_message_init:"gray",status_result_protected:"gray",status_result_error:"red",status_result_running:"green",status_result_optout:"gray",status_result_disabled:"gray"};function m(){if(!i)return;const e=!function(e,t){for(const[s,r]of Object.entries(e))if(t[s]!==r)return!1;for(const[s,r]of Object.entries(t))if(e[s]!==r)return!1;return!0}(c,i);u.disabled=!e}function y(){!async function(e){let t,s;e("status_init");try{if(t=await r.query({currentWindow:!0,active:!0}),t.length<1)return void e("status_no_tabs");if(t.length>1)throw new Error(`Got ${t.length} tabs in response to active tab query.`)}catch(t){return void e("status_tabs_error")}a=t[0],e("status_message_init");try{s=await r.sendMessage(a.id,{})}catch(t){return e("status_result_protected"),void(u.disabled=!0)}s?(i=s.tabSettings,s.loaded?e("status_result_running"):i.ruffleEnable?e("status_result_optout"):e("status_result_disabled"),m()):e("status_result_error")}((e=>{d.style.setProperty("--color",b[e]),g.textContent=t.getMessage(e)}))}window.addEventListener("DOMContentLoaded",(()=>{(async function(r){const o=function(){const e={};for(const t of document.getElementsByClassName("option")){const[s]=t.getElementsByTagName("input");if("checkbox"!==s.type)continue;const[r]=t.getElementsByTagName("label");e[s.id.replace(/[^a-z\d](.)/gi,((e,t)=>t.toUpperCase()))]={option:t,checkbox:s,label:r}}return e}(),n=await async function(t){const r=await s.sync.get(t);return Object.assign(Object.assign({},e),r)}(Object.keys(o));for(const[e,t]of Object.entries(n))o[e].checkbox.checked=t;for(const[e,{checkbox:r,label:a}]of Object.entries(o))r.addEventListener("click",(()=>{const t=r.checked;n[e]=t,s.sync.set({[e]:t})})),a.textContent=t.getMessage(`settings_${r.id}`),a.classList.add("notransition"),a.offsetHeight,a.classList.remove("notransition");s.onChanged.addListener(((e,t)=>{if("sync"===t){for(const[t,s]of Object.entries(e))o[t]&&(o[t].checkbox.checked=s.newValue,n[t]=s.newValue);r&&r(n)}})),r&&r(n)})((e=>{c=e,m()})),d=document.getElementById("status-indicator"),g=document.getElementById("status-text");const o=document.getElementById("options-button");o.textContent=t.getMessage("open_settings_page"),o.addEventListener("click",(()=>n())),u=document.getElementById("reload-button"),u.textContent=t.getMessage("action_reload"),u.addEventListener("click",(async()=>{await r.reload(a.id),setTimeout((()=>{y()}),1e3)})),y()}))})();